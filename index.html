<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visual Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
    </style>
    <script type="importmap">
{
  "imports": {
    "d3-scale": "https://esm.run/d3-scale",
    "d3-time": "https://esm.run/d3-time",
    "@google/genai": "https://esm.run/@google/genai",
    "lucide-react": "https://esm.sh/lucide-react@^0.559.0",
    "react": "https://esm.sh/react@^19.2.1",
    "react/": "https://esm.sh/react@^19.2.1/"
  }
}
</script>
</head>
<body class="bg-white font-sans text-slate-900 overflow-hidden h-screen flex flex-col">

    <!-- Header -->
    <header class="flex-none px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-white z-40 shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                <i data-lucide="calendar-days" width="24" height="24"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-none">VISUAL PLANNER</h1>
                <p class="text-[11px] text-slate-500 font-medium mt-1 tracking-wide">Use this to visualize your goals and your plans!</p>
            </div>
        </div>

        <div class="flex items-center space-x-4">
            <!-- Stats Counters -->
            <div class="hidden xl:flex items-center space-x-3 text-sm">
                <button onclick="app.openDrawer('MILESTONE')" class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200 hover:bg-slate-100 hover:border-amber-300 transition-all group">
                    <span class="text-slate-500 group-hover:text-amber-600">Milestones</span>
                    <span id="stat-milestone" class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <button onclick="app.openDrawer('TASK')" class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200 hover:bg-slate-100 hover:border-blue-300 transition-all group">
                    <span class="text-slate-500 group-hover:text-blue-600">Tasks</span>
                    <span id="stat-task" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <div class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200">
                    <span class="text-slate-500">Notes</span>
                    <span id="stat-note" class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </div>
            </div>

            <div class="h-8 w-px bg-slate-200 mx-1 hidden md:block"></div>

            <!-- Controls -->
            <div class="flex items-center space-x-3">
                <button onclick="app.scrollToToday()" class="flex items-center space-x-1 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg hover:bg-indigo-100 transition-colors text-sm font-medium border border-indigo-100">
                    <i data-lucide="calendar-check" width="16"></i>
                    <span>Jump to Today</span>
                </button>

                <button onclick="app.openEditor(null, 'marker')" class="flex items-center space-x-1 bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50 hover:text-slate-900 transition-all text-sm font-medium">
                    <i data-lucide="flag" class="text-indigo-500" width="16"></i>
                    <span class="hidden sm:inline">Add Marker</span>
                </button>

                <button id="btn-generate" onclick="app.generatePlan()" class="flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 disabled:opacity-50 transition-all shadow-md hover:shadow-lg text-sm font-medium">
                    <i data-lucide="wand-2" width="18"></i>
                    <span class="hidden sm:inline">AI Plan</span>
                </button>

                <div class="h-8 w-px bg-slate-200 mx-1 hidden md:block"></div>
                
                <!-- Storage Actions -->
                <div class="flex items-center space-x-1">
                    <input type="file" id="file-input" accept=".json" class="hidden">
                    <button onclick="document.getElementById('file-input').click()" class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Load">
                        <i data-lucide="upload" width="20"></i>
                    </button>
                    <button onclick="app.exportData()" class="p-2 text-slate-500 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Save">
                        <i data-lucide="save" width="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Timeline Area -->
    <main class="flex-1 relative overflow-hidden bg-slate-50 border-b border-slate-200">
        <!-- Zoom Controls -->
        <div class="absolute top-4 right-4 z-20 flex space-x-2 bg-white p-1 rounded-lg shadow-md border border-slate-200">
            <button onclick="app.zoom(-5)" class="p-2 hover:bg-slate-100 rounded-md text-slate-600"><i data-lucide="zoom-out" width="20"></i></button>
            <div class="w-px bg-slate-200 my-1"></div>
            <button onclick="app.zoom(5)" class="p-2 hover:bg-slate-100 rounded-md text-slate-600"><i data-lucide="zoom-in" width="20"></i></button>
        </div>

        <div id="timeline-container" class="w-full h-full overflow-x-auto overflow-y-hidden relative no-scrollbar cursor-crosshair">
            <div id="timeline-track" class="relative h-full min-w-full">
                <!-- Axis -->
                <div id="timeline-axis" class="absolute top-0 left-0 w-full h-[50px] border-b border-slate-300 bg-slate-50/90 backdrop-blur-sm sticky z-10 select-none"></div>
                
                <!-- Content Layers -->
                <div id="timeline-markers"></div>
                <div id="timeline-events"></div>
                
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-slate-400 text-sm pointer-events-none">
                    Scroll to explore â€¢ Click empty space to add event
                </div>
            </div>
        </div>
    </main>

    <!-- Persistent Floating Notes -->
    <div class="h-64 flex-none bg-white z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex flex-col">
        <div class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
            <span class="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                <i data-lucide="sticky-note" width="14"></i> General Notes / Scratchpad
            </span>
        </div>
        <textarea id="general-notes" class="flex-1 w-full p-4 resize-none outline-none text-sm text-slate-700 bg-white placeholder-slate-300 font-mono leading-relaxed" placeholder="Type your loose thoughts, goals, or scratchpad notes here. These will stay visible as you scroll the timeline..."></textarea>
    </div>

    <!-- Event Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                <h2 id="editor-title" class="text-lg font-bold text-gray-800">Edit Item</h2>
                <button onclick="app.closeEditor()" class="p-1 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="text-gray-500" width="20"></i></button>
            </div>
            
            <form id="editor-form" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-series-id">
                
                <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
                    <button type="button" onclick="app.setEditorType('standard')" id="type-standard" class="flex-1 py-2 text-sm font-medium rounded-md transition-all flex justify-center items-center">
                        <i data-lucide="layout" width="16" class="mr-2"></i> Card
                    </button>
                    <button type="button" onclick="app.setEditorType('marker')" id="type-marker" class="flex-1 py-2 text-sm font-medium rounded-md transition-all flex justify-center items-center">
                        <i data-lucide="flag" width="16" class="mr-2"></i> Visual Cue
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="edit-title" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="edit-category" onchange="app.handleCategoryChange(this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="MILESTONE">MILESTONE</option>
                            <option value="TASK">TASK</option>
                            <option value="MEETING">MEETING</option>
                            <option value="NOTE">NOTE</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                    <div id="icon-picker" class="grid grid-cols-6 gap-2 max-h-32 overflow-y-auto p-1"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="edit-color" class="h-10 w-20 p-1 rounded border cursor-pointer">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="edit-desc" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
                
                <!-- Recurrence Options -->
                <div id="recurrence-section" class="border-t border-slate-100 pt-3 mt-2">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="repeat" width="14"></i> Recurrence
                        </label>
                        <div class="flex items-center">
                            <input type="checkbox" id="edit-repeat" onchange="app.toggleRepeatFields()" class="w-4 h-4 text-indigo-600 rounded">
                            <span class="ml-2 text-sm text-gray-600">Repeat event</span>
                        </div>
                    </div>
                    
                    <div id="repeat-options" class="hidden space-y-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex space-x-2">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 block mb-1">Frequency</label>
                                <select id="edit-repeat-freq" class="w-full text-sm border rounded px-2 py-1.5 outline-none">
                                    <option value="daily">Daily</option>
                                    <option value="weekly" selected>Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="w-20">
                                <label class="text-xs text-gray-500 block mb-1">Every</label>
                                <div class="flex items-center">
                                    <input type="number" id="edit-repeat-interval" value="1" min="1" class="w-full text-sm border rounded px-2 py-1.5 text-center outline-none">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Until Date (Required)</label>
                            <input type="date" id="edit-repeat-until" class="w-full text-sm border rounded px-2 py-1.5 outline-none">
                        </div>
                    </div>
                </div>

                <div id="completed-check-wrapper" class="flex items-center space-x-2 pt-2">
                    <input type="checkbox" id="edit-completed" class="w-4 h-4 text-blue-600 rounded">
                    <label for="edit-completed" class="text-sm font-medium text-gray-700">Mark as Completed</label>
                </div>

                <div class="flex justify-between pt-2 mt-4 border-t border-gray-100 flex-shrink-0 gap-2">
                    <div class="flex gap-2">
                        <button type="button" id="btn-delete" onclick="app.deleteCurrentEvent()" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center text-sm font-medium border border-transparent hover:border-red-100 transition-all">
                            <i data-lucide="trash-2" width="16" class="mr-2"></i> Delete
                        </button>
                        <button type="button" id="btn-delete-series" onclick="app.deleteSeries()" class="hidden px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center text-sm font-medium border border-transparent hover:border-red-100 transition-all whitespace-nowrap">
                            <i data-lucide="layers" width="16" class="mr-2"></i> Delete Series
                        </button>
                    </div>
                    <button type="submit" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 flex items-center text-sm font-medium shadow-lg ml-auto">
                        <i data-lucide="save" width="16" class="mr-2"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Drawer -->
    <div id="drawer-overlay" onclick="app.closeDrawer()" class="fixed inset-0 z-50 bg-black/20 backdrop-blur-[1px] hidden transition-opacity duration-200"></div>
    <div id="drawer" class="fixed top-0 right-0 z-50 h-full w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h2 id="drawer-title" class="text-xl font-bold text-slate-800 flex items-center gap-2"></h2>
                <p id="drawer-subtitle" class="text-sm text-slate-500 mt-1"></p>
            </div>
            <button onclick="app.closeDrawer()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                <i data-lucide="x" class="text-slate-600" width="20"></i>
            </button>
        </div>
        <div id="drawer-content" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/30"></div>
    </div>

    <script type="module">
        import * as d3 from "d3-scale";
        import { GoogleGenAI, Type } from "@google/genai";

        // --- CONSTANTS ---
        const COLORS = {
            MILESTONE: '#f59e0b', // Amber
            TASK: '#3b82f6',      // Blue
            MEETING: '#8b5cf6',   // Violet
            NOTE: '#ef4444',      // Red
            OTHER: '#10b981'      // Emerald
        };
        const ICONS = [
            'star', 'heart', 'flag', 'alert', 'gift', 'calendar', 'zap', 'check', 'clock', 'briefcase', 'user',
            'lightbulb', 'target', 'mountain', 'plane', 'book', 'coffee', 'music', 'camera', 'home', 'smile', 
            'code', 'dollar-sign', 'dumbbell', 'utensils', 'shopping-cart', 'repeat'
        ];
        const VIEW_START = new Date('2025-01-01');
        const VIEW_END = new Date('2045-12-31');

        // --- STATE ---
        const state = {
            events: [],
            generalNotes: '',
            zoom: 25, // px per day
            currentEditorType: 'standard',
            drawerCategory: null
        };

        // --- INIT ---
        window.app = {
            state,
            init: () => {
                app.loadData();
                app.renderHeader();
                app.renderTimeline();
                
                // Load Notes
                document.getElementById('general-notes').value = state.generalNotes;

                // Event Listeners
                document.getElementById('timeline-container').addEventListener('click', (e) => {
                    if (e.target.id === 'timeline-track' || e.target.id === 'timeline-container') {
                        const rect = document.getElementById('timeline-container').getBoundingClientRect();
                        const scrollLeft = document.getElementById('timeline-container').scrollLeft;
                        const clickX = e.clientX - rect.left + scrollLeft;
                        const date = app.getDateFromX(clickX);
                        app.openEditor(null, 'standard', date);
                    }
                });

                document.getElementById('file-input').addEventListener('change', app.importData);
                document.getElementById('editor-form').addEventListener('submit', app.handleEditorSubmit);
                
                // Notes Saver
                document.getElementById('general-notes').addEventListener('input', (e) => {
                    state.generalNotes = e.target.value;
                    app.saveData();
                });

                // Initial Scroll
                setTimeout(() => app.scrollToToday(), 100);
            },

            // --- DATE UTILS ---
            formatDateForInput: (date) => date.toISOString().split('T')[0],
            formatDateDisplay: (dateStr) => {
                const parts = dateStr.split('-');
                if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
                return dateStr;
            },
            
            // --- DATA ---
            saveData: () => {
                const data = {
                    events: state.events,
                    generalNotes: state.generalNotes,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('visual_planner_data', JSON.stringify(data));
                app.renderHeader(); // Update stats
            },
            
            loadData: () => {
                const stored = localStorage.getItem('visual_planner_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    state.events = data.events || [];
                    state.generalNotes = data.generalNotes || '';
                } else {
                    // Try old fallback
                    const old = localStorage.getItem('blobby_data');
                    if (old) {
                        const parsed = JSON.parse(old);
                        // Migration logic
                         parsed.events.forEach(e => {
                            if (e.category === 'TODO') e.category = 'TASK';
                            if (e.category === 'MEDICAL') e.category = 'MEETING';
                            if (e.category === 'FACT') e.category = 'NOTE';
                            if (e.icon === 'baby') e.icon = 'star';
                        });
                        state.events = parsed.events;
                    }
                }
            },

            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                    events: state.events,
                    generalNotes: state.generalNotes
                }, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = `planner-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            importData: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        state.events = data.events || [];
                        state.generalNotes = data.generalNotes || '';
                        
                        // Update UI
                        document.getElementById('general-notes').value = state.generalNotes;
                        app.saveData();
                        app.renderTimeline();
                        app.renderHeader();
                        app.scrollToToday();
                        alert('Plan loaded successfully!');
                    } catch(err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            },

            // --- TIMELINE RENDER ---
            timeScale: null,

            zoom: (delta) => {
                state.zoom = Math.max(5, Math.min(100, state.zoom + delta));
                app.renderTimeline();
            },

            getDateFromX: (x) => {
                return app.timeScale.invert(x).toISOString().split('T')[0];
            },

            scrollToToday: () => {
                if(!app.timeScale) return;
                let today = new Date();
                // Clamp to view
                if (today < VIEW_START) today = VIEW_START;
                if (today > VIEW_END) today = VIEW_END;
                
                const x = app.timeScale(today);
                const container = document.getElementById('timeline-container');
                container.scrollLeft = x - container.clientWidth / 2;
            },

            renderTimeline: () => {
                const totalDays = Math.ceil((VIEW_END - VIEW_START) / (1000 * 60 * 60 * 24));
                const totalWidth = totalDays * state.zoom;
                
                // Scale
                app.timeScale = d3.scaleTime().domain([VIEW_START, VIEW_END]).range([0, totalWidth]);

                // Track Size
                const track = document.getElementById('timeline-track');
                track.style.width = `${totalWidth}px`;

                // Render Axis
                const axisHTML = [];
                let curr = new Date(VIEW_START);
                while(curr <= VIEW_END) {
                    const isMonthStart = curr.getDate() === 1;
                    const x = app.timeScale(curr);
                    const showDay = state.zoom >= 20;
                    const showTick = state.zoom >= 8;

                    if (isMonthStart || showTick) {
                        const h = isMonthStart ? 'h-6 border-slate-400' : 'h-3 border-slate-200';
                        let label = '';
                        if (isMonthStart) {
                            label = `<span class="font-bold text-slate-700">${curr.toLocaleDateString('en-GB', { month: 'short' })}</span>`;
                            if (state.zoom > 15) label += `<span class="text-slate-400 font-normal ml-1">${curr.getFullYear()}</span>`;
                        } else if (showDay) {
                            label = `<span class="text-slate-400 text-[10px]">${curr.getDate()}</span>`;
                        }

                        axisHTML.push(`
                            <div class="absolute bottom-0 border-l px-1 text-xs whitespace-nowrap transition-opacity ${h}" style="left: ${x}px">
                                ${label}
                            </div>
                        `);
                    }
                    curr.setDate(curr.getDate() + 1);
                }
                document.getElementById('timeline-axis').innerHTML = axisHTML.join('');

                // Render Events
                const markersEl = document.getElementById('timeline-markers');
                const eventsEl = document.getElementById('timeline-events');
                markersEl.innerHTML = '';
                eventsEl.innerHTML = '';

                // 1. Current Day Indicator
                const today = new Date();
                if (today >= VIEW_START && today <= VIEW_END) {
                    const todayX = app.timeScale(today);
                    markersEl.innerHTML += `
                        <div class="absolute top-0 bottom-0 w-0.5 border-l-2 border-dashed border-slate-400 opacity-50 pointer-events-none z-0" style="left: ${todayX}px;"></div>
                        <div class="absolute top-[45px] text-[10px] text-slate-500 font-medium px-1 bg-slate-50/80 backdrop-blur z-10" style="left: ${todayX}px;">Today</div>
                    `;
                }

                // 2. Custom Markers
                const markers = state.events.filter(e => e.type === 'marker');
                markers.forEach(ev => {
                    const x = app.timeScale(new Date(ev.date));
                    const iconEl = `<i data-lucide="${ev.icon || 'flag'}" width="24" height="24"></i>`;
                    const markerHTML = `
                        <div class="absolute top-[50px] bottom-0 w-1 pointer-events-none z-0 opacity-80" style="left: ${x}px; transform: translateX(-50%); background: linear-gradient(to bottom, ${ev.color}, transparent);"></div>
                        <div onclick="app.openEditor('${ev.id}')" class="absolute top-[26px] z-30 cursor-pointer hover:scale-110 transition-transform" style="left: ${x}px; transform: translateX(-50%)">
                            <div class="flex flex-col items-center group">
                                <div class="p-2 rounded-full shadow-lg border-4 border-slate-50 relative text-white" style="background-color: ${ev.color}">
                                    ${iconEl}
                                </div>
                                <div class="mt-1 bg-white/90 backdrop-blur text-[11px] font-bold px-3 py-0.5 rounded-full border shadow-sm whitespace-nowrap flex flex-col items-center" style="color: ${ev.color}; border-color: ${ev.color}">
                                    <span>${ev.title}</span>
                                    <span class="text-[9px] font-normal opacity-75">${app.formatDateDisplay(ev.date)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    markersEl.innerHTML += markerHTML;
                });

                // 3. Standard Cards (Layout Logic)
                const cards = state.events.filter(e => e.type !== 'marker').sort((a, b) => new Date(a.date) - new Date(b.date));
                const lanes = [];
                const HEADER_H = 50;
                const PADDING = 40;
                const ROW_H = 60;

                cards.forEach(ev => {
                    const x = app.timeScale(new Date(ev.date));
                    const w = 160;
                    
                    let laneIdx = lanes.findIndex(endX => endX + 10 < x);
                    if (laneIdx === -1) {
                        laneIdx = lanes.length;
                        lanes.push(0);
                    }
                    lanes[laneIdx] = x + w;

                    const top = HEADER_H + PADDING + (laneIdx * ROW_H);
                    const isDone = ev.isCompleted;
                    const opacity = isDone ? 'opacity-75 grayscale-[0.5]' : '';
                    const lineThrough = isDone ? 'line-through text-slate-500' : 'text-slate-800';
                    const iconCheck = isDone ? `<i data-lucide="check-circle-2" class="text-green-500 mt-0.5 flex-shrink-0" width="12"></i>` : '';
                    const borderCol = isDone ? '#cbd5e1' : ev.color;
                    const bgClass = isDone ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-200';

                    const cardHTML = `
                        <div onclick="app.openEditor('${ev.id}')" class="absolute group transition-all duration-200 cursor-pointer hover:z-20 hover:scale-105 ${opacity}" style="left: ${x}px; top: ${top}px; width: 150px;">
                            <div class="absolute h-full w-0.5 bg-slate-300 -top-4 left-0 -z-10 group-hover:bg-slate-400 transition-colors" style="height: 20px;"></div>
                            <div class="rounded-lg shadow-sm border p-2 text-left relative overflow-hidden flex items-start space-x-2 ${bgClass}" style="border-left: 4px solid ${borderCol}">
                                ${iconCheck}
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-xs truncate ${lineThrough}">${ev.title}</h4>
                                    <p class="text-[10px] text-slate-500 truncate">${app.formatDateDisplay(ev.date)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    eventsEl.innerHTML += cardHTML;
                });

                // Set container height based on rows
                track.style.height = `${HEADER_H + PADDING + (lanes.length + 1) * ROW_H + 200}px`;

                // Re-init icons
                lucide.createIcons();
            },

            renderHeader: () => {
                const milestones = state.events.filter(e => e.category === 'MILESTONE').length;
                const tasks = state.events.filter(e => e.category === 'TASK');
                const notes = state.events.filter(e => e.category === 'NOTE').length;
                const done = tasks.filter(e => e.isCompleted).length;

                document.getElementById('stat-milestone').textContent = milestones;
                document.getElementById('stat-task').innerHTML = done > 0 ? `<span class="opacity-60">${done}/</span>${tasks.length}` : tasks.length;
                document.getElementById('stat-note').textContent = notes;
            },

            // --- EDITOR ---
            openEditor: (id, type = 'standard', dateOverride = null) => {
                const modal = document.getElementById('editor-modal');
                const form = document.getElementById('editor-form');
                
                state.currentEditorType = type;
                app.updateEditorTypeUI();

                // Icon Picker
                const picker = document.getElementById('icon-picker');
                picker.innerHTML = ICONS.map(icon => `
                    <button type="button" onclick="app.selectIcon('${icon}')" class="icon-btn p-2 rounded-lg border flex items-center justify-center hover:bg-slate-50 transition-colors" data-icon="${icon}">
                        <i data-lucide="${icon}" width="20"></i>
                    </button>
                `).join('');
                lucide.createIcons();
                
                // Reset Recurrence UI
                document.getElementById('edit-repeat').checked = false;
                app.toggleRepeatFields();
                
                // Reset/Hide Delete Series button
                const btnDeleteSeries = document.getElementById('btn-delete-series');
                btnDeleteSeries.classList.add('hidden');

                if (id) {
                    const ev = state.events.find(e => e.id === id);
                    if (!ev) return;
                    document.getElementById('editor-title').textContent = 'Edit Item';
                    document.getElementById('edit-id').value = ev.id;
                    document.getElementById('edit-series-id').value = ev.seriesId || '';
                    document.getElementById('edit-title').value = ev.title;
                    document.getElementById('edit-date').value = ev.date;
                    document.getElementById('edit-category').value = ev.category;
                    document.getElementById('edit-color').value = ev.color;
                    document.getElementById('edit-desc').value = ev.description || '';
                    document.getElementById('edit-completed').checked = ev.isCompleted;
                    document.getElementById('btn-delete').style.visibility = 'visible';
                    state.currentEditorType = ev.type || 'standard';
                    app.selectIcon(ev.icon || 'star');
                    app.updateEditorTypeUI();

                    // If existing event, hide recurrence creation to avoid complexity for now, or maybe disable it
                    // For simplicity in this version, we hide recurrence creation when editing. 
                    // To extend a series, user should create new.
                    document.getElementById('recurrence-section').style.display = 'none';

                    if (ev.seriesId) {
                         btnDeleteSeries.classList.remove('hidden');
                    }

                } else {
                    document.getElementById('editor-title').textContent = 'Add New Item';
                    document.getElementById('edit-id').value = '';
                    document.getElementById('edit-series-id').value = '';
                    document.getElementById('edit-title').value = '';
                    document.getElementById('edit-date').value = dateOverride || app.formatDateForInput(new Date());
                    document.getElementById('edit-category').value = type === 'marker' ? 'MILESTONE' : 'TASK';
                    document.getElementById('edit-color').value = COLORS[type === 'marker' ? 'MILESTONE' : 'TASK'];
                    document.getElementById('edit-desc').value = '';
                    document.getElementById('edit-completed').checked = false;
                    document.getElementById('btn-delete').style.visibility = 'hidden';
                    
                    // Show recurrence for new items
                    document.getElementById('recurrence-section').style.display = 'block';
                    
                    app.selectIcon('star');
                }

                modal.classList.remove('hidden');
            },

            closeEditor: () => {
                document.getElementById('editor-modal').classList.add('hidden');
            },

            setEditorType: (type) => {
                state.currentEditorType = type;
                app.updateEditorTypeUI();
            },

            updateEditorTypeUI: () => {
                const isMarker = state.currentEditorType === 'marker';
                
                // Toggle Buttons
                const btnStd = document.getElementById('type-standard');
                const btnMrk = document.getElementById('type-marker');
                
                if (isMarker) {
                    btnStd.className = btnStd.className.replace('bg-white shadow-sm text-slate-900', 'text-slate-500');
                    btnMrk.className = btnMrk.className.replace('text-slate-500', 'bg-white shadow-sm text-slate-900');
                } else {
                    btnStd.className = btnStd.className.replace('text-slate-500', 'bg-white shadow-sm text-slate-900');
                    btnMrk.className = btnMrk.className.replace('bg-white shadow-sm text-slate-900', 'text-slate-500');
                }

                // Show/Hide fields
                document.getElementById('completed-check-wrapper').style.display = isMarker ? 'none' : 'flex';
            },

            toggleRepeatFields: () => {
                const isRepeat = document.getElementById('edit-repeat').checked;
                const options = document.getElementById('repeat-options');
                if (isRepeat) {
                    options.classList.remove('hidden');
                    document.getElementById('edit-repeat-until').required = true;
                } else {
                    options.classList.add('hidden');
                    document.getElementById('edit-repeat-until').required = false;
                }
            },

            selectIcon: (iconName) => {
                document.querySelectorAll('.icon-btn').forEach(btn => {
                    if (btn.dataset.icon === iconName) {
                        btn.classList.add('bg-slate-900', 'text-white', 'border-slate-900');
                        btn.classList.remove('hover:bg-slate-50');
                    } else {
                        btn.classList.remove('bg-slate-900', 'text-white', 'border-slate-900');
                        btn.classList.add('hover:bg-slate-50');
                    }
                });
                document.getElementById('editor-form').dataset.selectedIcon = iconName;
            },

            handleCategoryChange: (cat) => {
                document.getElementById('edit-color').value = COLORS[cat];
            },

            handleEditorSubmit: (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const title = document.getElementById('edit-title').value;
                const date = document.getElementById('edit-date').value;
                const category = document.getElementById('edit-category').value;
                const color = document.getElementById('edit-color').value;
                const desc = document.getElementById('edit-desc').value;
                const isCompleted = document.getElementById('edit-completed').checked;
                const icon = document.getElementById('editor-form').dataset.selectedIcon || 'star';
                
                // Recurrence
                const isRepeat = document.getElementById('edit-repeat').checked;

                const baseEvent = {
                    title,
                    description: desc,
                    category,
                    color,
                    isCompleted,
                    type: state.currentEditorType,
                    icon,
                    seriesId: document.getElementById('edit-series-id').value || (isRepeat ? crypto.randomUUID() : null)
                };

                if (id) {
                    // Update existing single event
                    state.events = state.events.map(ev => ev.id === id ? { ...baseEvent, id: id, date: date } : ev);
                } else {
                    // Create New
                    if (isRepeat) {
                        const freq = document.getElementById('edit-repeat-freq').value;
                        const interval = parseInt(document.getElementById('edit-repeat-interval').value) || 1;
                        const untilStr = document.getElementById('edit-repeat-until').value;
                        
                        if (!untilStr) {
                            alert("Please select an 'Until' date for repeating events.");
                            return;
                        }

                        const untilDate = new Date(untilStr);
                        let currDate = new Date(date);
                        const newEvents = [];

                        while(currDate <= untilDate) {
                            newEvents.push({
                                ...baseEvent,
                                id: crypto.randomUUID(),
                                date: app.formatDateForInput(currDate)
                            });

                            // Increment
                            if (freq === 'daily') currDate.setDate(currDate.getDate() + interval);
                            else if (freq === 'weekly') currDate.setDate(currDate.getDate() + (7 * interval));
                            else if (freq === 'monthly') currDate.setMonth(currDate.getMonth() + interval);
                            else if (freq === 'yearly') currDate.setFullYear(currDate.getFullYear() + interval);
                        }
                        
                        state.events = [...state.events, ...newEvents];
                        alert(`Created ${newEvents.length} repeating events.`);

                    } else {
                        // Single New Event
                        state.events.push({
                            ...baseEvent,
                            id: crypto.randomUUID(),
                            date: date
                        });
                    }
                }

                app.saveData();
                app.renderTimeline();
                app.closeEditor();
            },

            deleteCurrentEvent: () => {
                const id = document.getElementById('edit-id').value;
                if (id) {
                    state.events = state.events.filter(e => e.id !== id);
                    app.saveData();
                    app.renderTimeline();
                    app.closeEditor();
                }
            },

            deleteSeries: () => {
                const seriesId = document.getElementById('edit-series-id').value;
                if (seriesId && confirm("Are you sure you want to delete ALL events in this series?")) {
                    state.events = state.events.filter(e => e.seriesId !== seriesId);
                    app.saveData();
                    app.renderTimeline();
                    app.closeEditor();
                }
            },

            // --- DRAWER ---
            openDrawer: (category) => {
                state.drawerCategory = category;
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawer-overlay');
                const content = document.getElementById('drawer-content');
                const isTask = category === 'TASK';

                document.getElementById('drawer-title').innerHTML = isTask ? 
                    `<i data-lucide="check-circle-2" class="text-blue-500"></i> Tasks` : 
                    `<i data-lucide="star" class="text-amber-500" fill="currentColor"></i> Milestones`;
                
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    drawer.classList.remove('translate-x-full');
                    overlay.classList.remove('opacity-0');
                }, 10);

                const list = state.events
                    .filter(e => e.category === category)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                document.getElementById('drawer-subtitle').textContent = isTask ? 
                    `${list.filter(t=>t.isCompleted).length}/${list.length} completed` : 
                    `${list.length} items`;

                if (list.length === 0) {
                    content.innerHTML = `<div class="text-center text-slate-400 mt-10">No items found.</div>`;
                    lucide.createIcons();
                    return;
                }

                content.innerHTML = list.map(e => `
                    <div onclick="app.openEditor('${e.id}')" class="group flex items-start p-4 rounded-xl border transition-all cursor-pointer mb-3 ${e.isCompleted && isTask ? 'bg-slate-50 border-slate-200 opacity-75' : 'bg-white border-slate-200 hover:border-blue-300 shadow-sm'}">
                        ${isTask ? `
                            <div onclick="event.stopPropagation(); app.toggleComplete('${e.id}')" class="mt-0.5 mr-4 flex-shrink-0 transition-colors ${e.isCompleted ? 'text-green-500' : 'text-slate-300 hover:text-blue-500'}">
                                <i data-lucide="${e.isCompleted ? 'check-circle-2' : 'circle'}" width="24"></i>
                            </div>
                        ` : `
                             <div class="mt-0.5 mr-4 flex-shrink-0 text-amber-500">
                                <i data-lucide="star" width="20" fill="currentColor"></i>
                             </div>
                        `}
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm ${e.isCompleted && isTask ? 'line-through text-slate-500' : 'text-slate-800'}">${e.title}</h3>
                            <div class="flex items-center mt-2 text-xs text-slate-400">
                                <i data-lucide="calendar" width="12" class="mr-1"></i> ${app.formatDateDisplay(e.date)}
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            },

            closeDrawer: () => {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawer-overlay');
                drawer.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    state.drawerCategory = null;
                }, 300);
            },

            toggleComplete: (id) => {
                const ev = state.events.find(e => e.id === id);
                if (ev) {
                    ev.isCompleted = !ev.isCompleted;
                    app.saveData();
                    app.renderTimeline();
                    // Re-render drawer
                    if (state.drawerCategory) app.openDrawer(state.drawerCategory);
                }
            },

            // --- AI GENERATION ---
            generatePlan: async () => {
                const btn = document.getElementById('btn-generate');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" width="18"></i> Generating...`;
                lucide.createIcons();

                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const model = "gemini-2.5-flash";
                    const prompt = `
                        I want to organize my life and projects effectively. 
                        Generate a general productivity timeline starting from today (${new Date().toLocaleDateString()}).
                        Include generic but useful items such as:
                        - Regular Reviews (Weekly, Monthly)
                        - Goal Setting sessions
                        - General Maintenance tasks
                        - Motivational Notes
                        
                        Return a list of specific events with daysOffsetFromStart.
                        Categories: MILESTONE, TASK, MEETING, NOTE.
                    `;

                    const response = await ai.models.generateContent({
                        model: model,
                        contents: prompt,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        title: { type: Type.STRING },
                                        description: { type: Type.STRING },
                                        daysOffsetFromStart: { type: Type.NUMBER },
                                        category: { type: Type.STRING, enum: ['MILESTONE', 'TASK', 'MEETING', 'NOTE'] }
                                    },
                                    required: ["title", "description", "daysOffsetFromStart", "category"]
                                }
                            }
                        }
                    });

                    const rawData = JSON.parse(response.text || "[]");
                    const today = new Date();
                    const newEvents = rawData.map(item => {
                        const d = new Date(today);
                        d.setDate(d.getDate() + item.daysOffsetFromStart);
                        return {
                            id: crypto.randomUUID(),
                            title: item.title,
                            description: item.description,
                            date: app.formatDateForInput(d),
                            category: item.category,
                            color: COLORS[item.category] || COLORS.OTHER,
                            isCompleted: false,
                            type: 'standard'
                        };
                    });

                    state.events = [...state.events, ...newEvents];
                    app.saveData();
                    app.renderTimeline();
                    alert(`Added ${newEvents.length} items to your plan!`);

                } catch (error) {
                    console.error(error);
                    alert("Failed to generate plan. Please check API Key configuration.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }
            }
        };

        // Start
        app.init();
    </script>
</body>
</html>